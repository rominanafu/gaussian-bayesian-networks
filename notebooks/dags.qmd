---
title: "DAG contaminación ambiental"
format: html
---

```{r}
library(tidyverse)
library(bnlearn)
library(mgcv)
library(gratia)
library(ggplot2)
library(Rgraphviz)

data = read.csv("../data/data.csv")
data[] <- lapply(data, as.numeric)
head(data)
```

## Propuesta de modelo 1: Dra. Aleydis

#### Generar DAG

```{r}
dag1 = model2network("[suma_so_2][suma_co][suma_n_ox][suma_cov][suma_pm_010][suma_pm_2_5][suma_nh_3][pcr|suma_so_2:suma_co:suma_n_ox:suma_cov:suma_pm_010:suma_pm_2_5:suma_nh_3][ac_urico|suma_pm_2_5:suma_pm_010:suma_nh_3][creat|suma_pm_2_5:suma_pm_010:suma_nh_3]")
data_dag1 <- data[, nodes(dag1)]
graphviz.plot(dag1, shape = "ellipse")
```

#### Ajustar datos

```{r}
dag1_fit = bn.fit(dag1, data=data_dag1)

mod_so_2 = lm(suma_so_2 ~ 1, data=data_dag1)
mod_co = lm(suma_co ~ 1, data=data_dag1)
mod_nox = lm(suma_n_ox ~ 1, data=data_dag1)
mod_cov = lm(suma_cov ~ 1, data=data_dag1)
mod_pm_010 = lm(suma_pm_010 ~ 1, data=data_dag1)
mod_pm_2_5 = lm(suma_pm_2_5 ~ 1, data=data_dag1)
mod_nh_3 = lm(suma_nh_3 ~ 1, data=data_dag1)

mod_gam_pcr = gam(pcr ~ s(suma_so_2) + s(suma_co) + s(suma_n_ox) + s(suma_cov) + s(suma_pm_2_5) + s(suma_pm_010) + s(suma_nh_3), data=data_dag1, method="REML")
mod_gam_ac_urico = gam(ac_urico ~ s(suma_pm_2_5) + s(suma_pm_010) + s(suma_nh_3), data=data_dag1, method="REML")
mod_gam_creat = gam(creat ~ s(suma_pm_2_5) + s(suma_pm_010) + s(suma_nh_3), data=data_dag1, method="REML")
```

#### BIC

```{r}
-1/2*(BIC(mod_so_2) + BIC(mod_co) + BIC(mod_nox) + BIC(mod_cov) + BIC(mod_pm_010) +
        BIC(mod_pm_2_5) + BIC(mod_nh_3) + BIC(mod_gam_pcr) + BIC(mod_gam_ac_urico) +
        BIC(mod_gam_creat))
```

#### AIC

```{r}
-1/2 * (AIC(mod_so_2) + AIC(mod_co) + AIC(mod_nox) + AIC(mod_cov) + AIC(mod_pm_010) +
        AIC(mod_pm_2_5) + AIC(mod_nh_3) + AIC(mod_gam_pcr) + AIC(mod_gam_ac_urico) +
        AIC(mod_gam_creat))
```

## Propuesta 2: Dra. Silvia Rodríguez, Dr. Ricardo Cano

#### Generar DAG

```{r}
dag2 = model2network("[suma_so_2][suma_n_ox][suma_pm_010][suma_pm_2_5][suma_nh_3][edad][pcr|suma_so_2:suma_n_ox:suma_pm_010:suma_pm_2_5:suma_nh_3:edad][ac_urico|suma_so_2:suma_n_ox:suma_pm_010:suma_pm_2_5:suma_nh_3:edad][ferritina|suma_so_2:suma_n_ox:suma_pm_010:suma_pm_2_5:suma_nh_3:edad]")
data_dag2 <- data[, nodes(dag2)]
graphviz.plot(dag2, shape = "ellipse")
```


#### Ajustar datos

```{r}
dag2_fit = bn.fit(dag2, data=data_dag2)

mod_so_2 = lm(suma_so_2 ~ 1, data=data_dag2)
mod_nox = lm(suma_n_ox ~ 1, data=data_dag2)
mod_pm_0_10 = lm(suma_pm_010 ~ 1, data=data_dag2)
mod_pm_2_5 = lm(suma_pm_2_5 ~ 1, data=data_dag2)
mod_nh_3 = lm(suma_nh_3 ~ 1, data=data_dag2)

mod_gam_pcr = gam(pcr ~ s(suma_so_2) + s(suma_n_ox) + s(suma_pm_2_5) + s(suma_pm_010) + s(suma_nh_3), data=data_dag2, method="REML")
mod_gam_ac_urico = gam(ac_urico ~ s(suma_so_2) + s(suma_n_ox) + s(suma_pm_2_5) + s(suma_pm_010) + s(suma_nh_3), data=data_dag2, method="REML")
mod_gam_ferritina = gam(ferritina ~ s(suma_so_2) + s(suma_n_ox) + s(suma_pm_2_5) + s(suma_pm_010) + s(suma_nh_3), data=data_dag2, method="REML")
```

#### BIC

```{r}
-1/2*(BIC(mod_so_2) + BIC(mod_nox) + BIC(mod_pm_0_10) + BIC(mod_pm_2_5) +
        BIC(mod_nh_3) + BIC(mod_gam_pcr) + BIC(mod_gam_ac_urico) +
        BIC(mod_gam_ferritina))
```

```{r}
-1/2 * (AIC(mod_so_2) + AIC(mod_nox) + AIC(mod_pm_0_10) + AIC(mod_pm_2_5) +
        AIC(mod_nh_3) + AIC(mod_gam_pcr) + AIC(mod_gam_ac_urico) +
        AIC(mod_gam_ferritina))
```


### Super DAG
```{r}
nodos <- c("suma_co","suma_n_ox","suma_so_2","suma_cov","suma_nh_3","suma_pm_010","suma_pm_2_5",
           "pcr","glu_suero","hb1ac","eag","insulina","vit_d","vit_b12","creat",
           "ac_urico","hcst","ferritina","trig","col_hdl","col_ldl","colest","albu")

data_dag3 <- data[, nodos]


dag3 <- empty.graph(nodos)


arcos <- matrix(c(
  
  "suma_co","pcr",
  "suma_n_ox","pcr",
  "suma_so_2","pcr",
  "suma_cov","pcr",
  "suma_nh_3","pcr",
  "suma_pm_010","pcr",
  "suma_pm_2_5","pcr",
  
  
  "pcr","glu_suero",
  "pcr","hcst",
  
  
  "glu_suero","hb1ac",
  "hb1ac","eag",
  "glu_suero","insulina",
  "hb1ac","vit_d",
  "vit_d","vit_b12",
  "vit_d","creat",
  "creat","ac_urico",
  "eag","ac_urico",
  "hcst","ferritina",
  
  
  "pcr","trig",
  "suma_pm_010","trig",
  "suma_pm_2_5","trig",
  "trig","col_hdl",
  "trig","col_ldl",
  "col_ldl","colest",
  "trig","albu"
), byrow=TRUE, ncol=2)


arcs(dag3) <- arcos


graphviz.plot(dag3, shape = "ellipse")
```

#### Ajustar datos

```{r}
dag3_fit = bn.fit(dag3, data=data_dag3)

mod_so_2 = lm(suma_so_2 ~ 1, data=data_dag3)
mod_nox = lm(suma_n_ox ~ 1, data=data_dag3)
mod_co = lm(suma_co ~ 1, data=data_dag3)
mod_cov = lm(suma_cov ~ 1, data=data_dag3)
mod_pm_0_10 = lm(suma_pm_010 ~ 1, data=data_dag3)
mod_pm_2_5 = lm(suma_pm_2_5 ~ 1, data=data_dag3)
mod_nh_3 = lm(suma_nh_3 ~ 1, data=data_dag3)

mod_gam_pcr = gam(pcr ~ s(suma_so_2) + s(suma_n_ox) + s(suma_pm_2_5) + s(suma_pm_010) + s(suma_nh_3) + s(suma_co) + s(suma_cov), data=data_dag3, method="REML")
mod_gam_hcst = gam(hcst ~ s(pcr), data=data_dag3, method="REML")
mod_gam_glu_suero = gam(glu_suero ~ s(pcr), data=data_dag3, method="REML")
mod_gam_trig = gam(trig ~ s(pcr) + s(suma_pm_2_5) + s(suma_pm_010), data=data_dag3, method="REML")
mod_gam_ferritina = gam(ferritina ~ s(hcst), data=data_dag3, method="REML")
mod_gam_insulina = gam(insulina ~ s(glu_suero), data=data_dag3, method="REML")
mod_gam_hb1ac = gam(hb1ac ~ s(glu_suero), data=data_dag3, method="REML")
mod_gam_col_hdl = gam(col_hdl ~ s(trig), data=data_dag3, method="REML")
mod_gam_col_ldl = gam(col_ldl ~ s(trig), data=data_dag3, method="REML")
mod_gam_albu = gam(albu ~ s(trig), data=data_dag3, method="REML")
mod_gam_eag = gam(eag ~ s(hb1ac), data=data_dag3, method="REML")
mod_gam_vit_d = gam(vit_d ~ s(hb1ac), data=data_dag3, method="REML")
mod_gam_colest = gam(colest ~ s(col_ldl), data=data_dag3, method="REML")
mod_gam_vit_b12 = gam(vit_b12 ~ s(vit_d), data=data_dag3, method="REML")
mod_gam_creat = gam(creat ~ s(vit_d), data=data_dag3, method="REML")
mod_gam_ac_urico = gam(ac_urico ~ s(eag) + s(creat), data=data_dag3, method="REML")
```

#### BIC

```{r}
-1/2*(BIC(mod_so_2) + BIC(mod_nox) + BIC(mod_co) + BIC(mod_cov) + BIC(mod_pm_0_10) +
        BIC(mod_pm_2_5) + BIC(mod_nh_3) + BIC(mod_gam_pcr) + BIC(mod_gam_hcst) +
        BIC(mod_gam_glu_suero) + BIC(mod_gam_trig) + BIC(mod_gam_ferritina) +
        BIC(mod_gam_insulina) + BIC(mod_gam_hb1ac) + BIC(mod_gam_col_hdl) +
        BIC(mod_gam_col_ldl) + BIC(mod_gam_albu) + BIC(mod_gam_eag) +
        BIC(mod_gam_vit_d) + BIC(mod_gam_colest) + BIC(mod_gam_vit_b12) +
        BIC(mod_gam_creat) + BIC(mod_gam_ac_urico)
)
```

```{r}
-1/2 * (AIC(mod_so_2) + AIC(mod_nox) + AIC(mod_co) + AIC(mod_cov) + AIC(mod_pm_0_10) +
  AIC(mod_pm_2_5) + AIC(mod_nh_3) + AIC(mod_gam_pcr) + AIC(mod_gam_hcst) +
  AIC(mod_gam_glu_suero) + AIC(mod_gam_trig) + AIC(mod_gam_ferritina) +
  AIC(mod_gam_insulina) + AIC(mod_gam_hb1ac) + AIC(mod_gam_col_hdl) +
  AIC(mod_gam_col_ldl) + AIC(mod_gam_albu) + AIC(mod_gam_eag) +
  AIC(mod_gam_vit_d) + AIC(mod_gam_colest) + AIC(mod_gam_vit_b12) +
  AIC(mod_gam_creat) + AIC(mod_gam_ac_urico))
```

### Queries

¿Cuál es la probabilidad que una persona de 20 años o menos tenga niveles de ferritina mayores a 100 respecto a las personas mayores de 50 años en lugares con niveles de NOx mayores a 20,000?

```{r}
p_menor <- cpquery(dag2_fit, event = (ferritina>100), evidence=(edad<=20 & suma_n_ox>20000), n = 10^6)
p_mayor <- cpquery(dag2_fit,event = (ferritina > 100), evidence = (edad > 50 & suma_n_ox > 20000), n = 10^6)
p_menor
p_mayor
```
¿Cuál es la probabilidad de que una persona viva en un municipio con niveles de PM_{10} mayores a 20,000 dado que su nivel de ácido úrico es menor a 3 respecto a las personas con nivel de 6 o más?
```{r}
p_bajo <- cpquery(dag2_fit,event = (suma_pm_010 > 2000), evidence = (ac_urico < 3),n = 10^6 )
p_alto <- cpquery(dag2_fit,event = (suma_pm_010 > 2000), evidence = (ac_urico >= 6), n = 10^6)
p_bajo
p_alto
```

```{r}
p_ferritina_alta <- cpquery(dag2_fit, event = (ferritina > 50), evidence = (suma_nh_3 > 6000 & suma_so_2 > 200),n = 10^6)
p_ferritina_alta
```

